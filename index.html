<!DOCTYPE html>
<html>
<head>
<title>JQuery Simple Vote</title>
<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="javascripts/sha1.js"></script>
<script src="javascripts/jsonld.js"></script>
<script src="javascripts/jsonld-turtle.js"></script>

<script type="text/javascript">


(function($) {
  
  var app = function() { this.load() };
  app.prototype = {
    
    friends: [],
    statuses: [],
    voted: false,
    reviews: [],
    voteName : '1',
    title : 'Loading',
  
    // Starting point
    load: function() {
      this.status('Loading user...', true);
      this.loadUser();
      this.render();
    },
    
    // Load user details, callback to displayUser
    loadUser: function() {
      // Non Facebook
      if (window.location.hash.length == 0) {
        var script = document.createElement('script');
        script.src = 'https://data.fm/user.js?callback=document.app.displayUser';
        document.body.appendChild(script);   
      // Facebook     
      } else {
        var accessToken = window.location.hash.substring(1);
        var path = "https://graph.facebook.com/me?";
        var queryParams = [accessToken, 'callback=document.app.displayUser'];
        var query = queryParams.join('&');
        var url = path + query;

        var script = document.createElement('script');
        script.src = url;
        document.body.appendChild(script);        
      }
    },
    
    // callback to loadFriends, calls loadRemote
    displayUser: function(user) {
      this.status('Loading user...', false);
      var userName = document.getElementById('welcome');
      if ( user.name ) {
        var greetingText = document.createTextNode('Greetings, ' + user.name + '.');
        window.user = 'https://graph.facebook.com/' + user.id;
        userName.innerHTML = 'Greetings, ' + user.name;
        this.loadFBFriends();
      } else {
        window.user = user; 
        var userName = document.getElementById('welcome');
        if (user.substring(0,4) == 'dns:' ) {
          userName.innerHTML = 'IP: ' + window.user + '&nbsp;' + '<a href="javascript:document.app.loginPopup()"><img src="https://browserid.org/i/sign_in_blue.png"/'+'></a>' ;
        } else {
          userName.innerHTML = 'User: ' + window.user;
        }
      }
      this.loadRemote();
    },
    
    // callback to displayFriends
    loadFBFriends: function() {
      this.status('Loading friends...', true);
      var accessToken = window.location.hash.substring(1);
      var path = "https://graph.facebook.com/me/friends?";
      var queryParams = [accessToken, 'callback=document.app.displayFriends'];
      var query = queryParams.join('&');
      var url = path + query;

      // use jsonp to call the graph
      var script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);        
    },    

    displayFriends: function(data) {
      this.status('Loading friends...', false);
      var str;
      for (i=0; i<data['data'].length; i++) {
        var uri  = 'https://graph.facebook.com/' + data['data'][i].id;
        var name = data['data'][i].name;
        this.addFriend( uri, name );
      }
      this.render();
    },

    // called from add button
    addRecipient: function() {
      var uri  = this.makeURI($('#uri').val());
      var name = $('#name').val();
      
      this.addFriend( uri , name );
      this.saveRemote();
      
      alert( name + ' added!' );
      this.render();
    },

    // called from fb button
    FBLogin: function() {
      var appID = "119467988130777";
      if (window.location.hash.length == 0) {
        var path = 'https://www.facebook.com/dialog/oauth?';
        var queryParams = ['client_id=' + appID,
          'redirect_uri=' + window.location,
          'response_type=token'];
        var query = queryParams.join('&');
        var url = path + query;
        window.location = url;
      } else {
      }
    },

    
    loadRemote: function() {
      this.status('Loading poll...', true);
      
      // get user
      var user = window.user;
      if (!user) return;
      var userSha1 = hex_sha1(user);
      
      that = this;
      
      var baseDir = 'http://vote.data.fm/';
      

      $.getJSON(baseDir + this.voteName +'.ttl.json' , function(data){
        for(var prop in data) {
          if(data.hasOwnProperty(prop)) {
            var reviewer = undefined;
            if ( data[prop]['http://purl.org/stuff/rev#title'] && data[prop]['http://purl.org/stuff/rev#title'][0] )
              var title  = data[prop]['http://purl.org/stuff/rev#title'][0]['value'];
            if ( data[prop]['http://plugin.org.uk/rdf/vote#for'] && data[prop]['http://plugin.org.uk/rdf/vote#for'][0] )
              var option = data[prop]['http://plugin.org.uk/rdf/vote#for'][0]['value'];
            if ( data[prop]['http://purl.org/stuff/rev#reviewer'] && data[prop]['http://purl.org/stuff/rev#reviewer'][0] )
              reviewer = data[prop]['http://purl.org/stuff/rev#reviewer'][0]['value'];
            if ( title && title != this.title ) this.title = title;
            document.app.addReview(option, reviewer, title);
          }
        }
        that.status('Loading poll...', false);
        that.render();
      }).error(function(data){
        that.addFriend('testdummy@opentabs.net', 'Test Dummy');
        that.status('Loading poll...', false);
        that.render();
      });
    },
    
    saveRemote: function() {
      that = this;
      that.status('Loading poll...', true);
      

      var baseDir = 'http://vote.data.fm/';
      // DELETE
      this.deleteFile(baseDir + '1.ttl');      

      // PUT
      var body = jsonld.turtle(this.reviews);
      //alert(JSON.stringify(body));
      this.putFile(baseDir + '1.ttl', body);      

      
      that.status('Loading poll...', false);
    },
    
    createReview: function(option, reviewer, title) {
       title = title || this.title;
       
       var review = {
                     "@id": "",
                     "http://purl.org/stuff/rev#title": title,
                     "http://plugin.org.uk/rdf/vote#for" : option,
                     "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": {
                         "@id": "http://purl.org/stuff/rev#Review"
                      }
                    };
             
                   
      review['@id'] = '#' + hex_sha1(JSON.stringify(review));             

      if (reviewer) {
        review ["http://purl.org/stuff/rev#reviewer"] = { "@id": this.makeURI(reviewer) };
      }

      return review;
    
    },    
    

    // render
    render: function() {
      that = this;
      
      
      var title = this.title;
      var options = {};
      for (i=0; i<this.reviews.length; i++) {
        title = this.reviews[i]["http://purl.org/stuff/rev#title"];
        
        var reviewer= this.reviews[i]["http://purl.org/stuff/rev#reviewer"];
        var option = this.reviews[i]["http://plugin.org.uk/rdf/vote#for"];

        if ( reviewer == window.user ) {        
          document.app.voted = true;
          $('#thanks').html('Thank you for voting');
        }
        
        if (!options[option]) {
          options[option] = [];
        } 
        
        if (reviewer) {
          options[option].push(reviewer);
        }
        
        
        
      }
      
      $('#question').html(title);   
      that.title = title;
      
      //alert(line);
      $('#choices').empty();
      
      
      for(var prop in options) {
        if(options.hasOwnProperty(prop)) {
          var line = '<div title="'+ encodeURI(JSON.stringify(options[prop])) +'"><span>'+ options[prop].length +'</span><a href="">Vote</a>'+ prop +'</div>';
          $('#choices').append( line );
          $('div:contains("'+prop+'")').last().animate({ width : "+="+ (100*options[prop].length) +"" })
        }
      }
        
      
      this.handleVotes();
            
    },
    
    // Helpers

    addFriend: function(uri, name) {
      for (i=0; i<this.friends.length; i++) {
        if ( uri == this.friends[i]['@id'] && name == this.friends[i]['http://xmlns.com/foaf/0.1/name'] ) return;
      }
      
      this.friends.push({ "@id" : uri, "http://xmlns.com/foaf/0.1/name" : name });
      window.localStorage.friends = JSON.stringify(this.friends);
    },
    
    addReview: function(option, reviewer, title) {
      this.reviews.push(this.createReview(option, reviewer, title));

    },
    
    deleteFile: function(file) {
      var body = '';
      xhr = new XMLHttpRequest();
      xhr.open('DELETE', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(body);      
    },
    
    putFile: function(file, data) {
      xhr = new XMLHttpRequest();
      xhr.open('PUT', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(data);   
    },
    
    createDirectory: function(dir) {
      var xhr = new XMLHttpRequest();
      xhr.open('MKCOL', dir, false);
      xhr.send();
    },

    status: function(message, add) {
      if (add) {
        this.statuses.push(message);
      } else {
        for (i=0; i<this.statuses.length; i++) {
          if (message == this.statuses[i]) {
            this.statuses.splice(i, 1);
          }
        }
      }
      if (this.statuses.length) {
        $('#status').html(this.statuses[0]);
      } else {
        $('#status').html('');
      }
    },

    
    makeURI: function(id) {
      if ( id.substring(0,7) == 'mailto:' ) {
        return id;
      } else if ( id.indexOf(':') != -1 ) {
        return id;
      } else {
        return 'mailto:' + id;
      }
    },
    
    addR: function(id) {
      $('#addRecipient').dialog();
    },
    
    loginPopup: function(id) {
      $('#loginPopup').dialog();
    },
    

    handleVotes: function() {
      that = this;
      
      $("#container div a").click(function() {
          if (document.app.voted) return false;
          $(this).parent().animate({
             width: '+=100px'
          }, 500);

          $(this).prev().html(parseInt($(this).prev().html()) + 1);
          document.app.voted = true;
          $('#thanks').html('Thank you for voting');
          var option = $(this).parent().text();
          var needle = option.indexOf('Vote');
          option = option.substring(needle+4);
          //alert(title);
          document.app.reviews.push(document.app.createReview(option, window.user, that.title));
          // save poll
          that.saveRemote();
          return false;
      });
    }
  };
  
  // Init
  $(document).ready(function() {

    document.app = new app; 
    document.app.handleVotes();
    
  });
  
})(jQuery);



</script>
<style type="text/css">
    * {
        font-family: Arial, "Free Sans";
    }
    #container {
        margin-top: 20px;
        color: #fff;
    }
    #container #question #choices {
        display: block;
        padding: 20px;
        font-weight: bold;
        letter-spacing: -3px;
        margin-bottom: 20px;
        padding: 10px;
        font-size: 40px;
    }
    #container div {
        font-weight: bold;
        letter-spacing: -3px;
        background: #0099cc;
        margin-bottom: 15px;
        padding: 10px;
        font-size: 34px;
        color: #ffffff;
        border-left: 20px solid #333;
        width: 600px;
        -webkit-border-radius: 0.5em;
        -moz-border-radius: 0 0.5em 0.5em 0;
        border-radius: 0 1.5em 1.5em 0;
    }
    #container div a {
        border-radius: 0.3em;
        text-decoration: none;
        color: #0099cc;
        padding: 5px 15px;
        background: #333;
        margin: 0 20px;
    }
    #container div a:hover {
        color: #fff;
    }
    #main {
        background: #0099cc;
        margin-top: 0;
        padding: 2px 0 4px 0;
        text-align: center;
    }
    #main a {
        color: #ffffff;
        text-decoration: none;
        font-size: 12px;
        font-weight: bold;
        font-family: Arial;
    }
    #main a:hover {
        text-decoration: underline;
    }
    body {
        margin: 0;
        padding: 0;
        background: black;
    }
    #text {
        margin: 0 auto;
        width: 500px;
        font-size: 12px;
        color: #0099cc;
        font-weight: bold;
        text-align: center;
        margin-top: 20px;
    }
    .hide {
        display:none;
    }

</style>
</head>
<body>
    <div id="main">

<span id="welcome"><a href="javascript:document.app.loginPopup()"><img src="https://browserid.org/i/sign_in_blue.png"/></a></span></span><span id="status"></span>

  </div>
  <div id="container">
      <h2 id="question">Loading...</h2>
      <span id="choices">
          <div><span>0</span><a href="">Vote</a>Loading...</div>
      </span>
      <h2 id="thanks"></h2>
  </div>

  <form id="loginPopup" class="hide" action="https://data.fm/rp_auth">
    &nbsp;WebID <a href="https://data.fm/login?next=http://appbuilder.data.fm/"><img height="60" width="105" style="float: left" src="http://www.w3.org/wiki/images/0/03/Foaf%2Bssl%24foaf_keylock_small.png" /></a><br/>
    <br/><br/><a href="javascript:document.app.FBLogin()"><img src="http://www.ikerjimenez.com/imagenes/logo-facebook.gif" /></a><br/>
    <a href="https://data.fm/login?provider=Gmail&next=http://appbuilder.data.fm/"><img src="https://s3.amazonaws.com/foaf/gmail.png" /></a><br/>
    <a href="https://data.fm/login?provider=Yahoo&next=http://appbuilder.data.fm/"><img src="https://s3.amazonaws.com/foaf/yahoo.png" /></a><br/>
  </form>


</body>
</html>
