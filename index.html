<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<!--
    Copyright (C) 25 Dec 2011 Melvin Carvalho, Nathan Rixham

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<head>
    <meta charset="utf-8">
    <title>App Builder</title>

    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="stylesheets/base.css">
    <link rel="stylesheet" href="stylesheets/skeleton.css">
    <link rel="stylesheet" href="stylesheets/layout.css">

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">


    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">

    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <style>
        .hide    { display: none; }
        .status  { color: rgb(23, 136, 23) ; font-weight:bold; }
        .alpha   { vertical-align: super; font-size: small; color: grey; }
    </style>


</head>
<body>

<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>

    <div class="container">

        <div class="sixteen columns">
            <h1 class="remove-bottom" style="margin-top: 40px">App Builder <span class="alpha">Alpha</span></h1>

            <h5 id="welcome">Loading...</h5>
        </div>
        <div class="one-third column">
            <hr />

          <ul class="tabs">
            <!-- Give href an ID value of corresponding "tabs-content" <li>'s -->
            <li><a class="active" href="#simple">Main</a></li>

            <li><a href="#advanced">Advanced</a></li>
          </ul>

          <ul class="tabs-content">     
            <li id="simple" class="active">
              
              <div id="main">Content Goes Here.</div>
              <div class="status" id="status"></div>

            <li id="advanced">
              <div id="main">Advanced Tab</div>              
            </li>
          </ul>

        </div>
        
        <form id="loginPopup" class="hide" action="https://data.fm/rp_auth">
          &nbsp;BrowserID <a id="loginBrowserID" href="#"><img width="158" height="44" style="float: left" src="https://browserid.org/i/sign_in_blue.png" /></a><br/>
          <br/><br/><a id="loginFacebook" href="#"><img src="http://www.ikerjimenez.com/imagenes/logo-facebook.gif" /></a><br/>
          <a id="loginGmail" href="#"><img src="https://s3.amazonaws.com/foaf/gmail.png" /></a><br/>
          <a id="loginYahoo" href="#"><img src="https://s3.amazonaws.com/foaf/yahoo.png" /></a><br/>
          &nbsp;WebID <a id="loginWebID" href="#"><img height="60" width="105" style="float: left" src="http://www.w3.org/wiki/images/0/03/Foaf%2Bssl%24foaf_keylock_small.png" /></a>
        </form>

    </div>


<script src="javascripts/tabs.js"></script>
<script src="javascripts/sha1.js"></script>
<script src="javascripts/jsonld.js"></script>
<script src="javascripts/jsonld-turtle.js"></script>
<script src="https://browserid.org/include.js" type="text/javascript"></script>
<script>

(function($) {
  
  var app = function() { this.load() };
  app.prototype = {
    
    appURI: 'https://github.com/melvincarvalho/appbuilder', // DOAP
    webIDAuthURI : 'https://data.fm/user.js',
    loginType : 'loginMulti', 
    //loginType : 'loginBrowserID', 
    friends: [],
    statuses: [],
    user: null,

    // Facebook ID -- change or add more
    facebookAppID : '119467988130777',
    facebookAppURL : 'data.fm',

  
    // INIT
    load: function() {
      this.initLogin();
      this.loadUser();
      this.render();
    },
    
    // AUTHENTICATION
    initLogin: function() {
      $('#loginBrowserID').click(function () {document.app.loginBrowserID();});
      $('#loginGmail').attr('href', 'https://data.fm/login?provider=Gmail&next=' + document.URL );
      $('#loginYahoo').attr('href', 'https://data.fm/login?provider=Yahoo&next=' + document.URL );
      $('#loginWebID').attr('href', 'https://data.fm/login?next=' + document.URL );
      if (document.URL.indexOf(this.facebookAppURL) != -1) {
        $('#loginFacebook').click(function () {document.app.loginFacebook();});
      } else {
        $('#loginFacebook').hide();
      }
    },
    
    loadUser: function() {
      this.status('Loading user...', true);
      // Non Facebook
      if (window.location.hash.length == 0) {
        var script = document.createElement('script');
        script.src = this.getWebIDAuthURI() + '?callback=document.app.displayUser';
        document.body.appendChild(script);   
      // Facebook     
      } else {
        var accessToken = window.location.hash.substring(1);
        var path = "https://graph.facebook.com/me?";
        var queryParams = [accessToken, 'callback=document.app.displayUser'];
        var query = queryParams.join('&');
        var url = path + query;

        var script = document.createElement('script');
        script.src = url;
        document.body.appendChild(script);        
      }
    },
    
    // Multi login modal popup
    loginMulti: function(id) {
      $('#loginPopup').dialog({"title": "Sign in"});
    },
    
    // Called from fb button
    loginFacebook: function() {
      var appID = this.facebookAppID;
      if (window.location.hash.length == 0) {
        var path = 'https://www.facebook.com/dialog/oauth?';
        var queryParams = ['client_id=' + appID,
          'redirect_uri=' + window.location,
          'response_type=token'];
        var query = queryParams.join('&');
        var url = path + query;
        window.location = url;
      } else {
      }
    },
    
    // Called from BrowserID button
    loginBrowserID: function() {
      navigator.id.get(function(assertion) {
        if (assertion) {
    
          var arr = assertion.split('.');
          var f = JSON.parse(window.atob(arr[1]));
          var user = f['principal']['email'];
          document.getElementById('welcome').innerHTML = user + '<a href="javascript:document.app.logout()"><img height="24" width="24" src="images/logout.png"/'+'></a>';
          document.app.user = 'mailto:' +  user;
          $('#loginPopup').dialog('close');
          document.app.loadRemote();

          
          // This code will be invoked once the user has successfully
          // selected an email address they control to sign in with.
        } else {
          // something went wrong!  the user isn't logged in.
        }
      });      
    },
    
    // Displays users, callback to loadFriends, loadRemote
    displayUser: function(user) {
      this.status('Loading user...', false);
      var userName = document.getElementById('welcome');
      if ( user.name ) {
        var greetingText = document.createTextNode('Greetings, ' + user.name + '.');
        document.app.user = 'https://graph.facebook.com/' + user.id;
        userName.innerHTML = 'Greetings, ' + user.name;
        this.loadFBFriends();
      } else {
        document.app.user = user; 
        var userName = document.getElementById('welcome');
        if (user.substring(0,4) == 'dns:' ) {
          var signin = 'javascript:document.app.' + this.loginType + '()';
          userName.innerHTML = 'IP: ' + document.app.user + '&nbsp;' + '<a href="'+signin+'"><img src="https://browserid.org/i/sign_in_blue.png"/'+'></a>' ;
        } else {
          userName.innerHTML = 'User: ' + document.app.user + '<a href="javascript:document.app.logout()"><img height="24" width="24" src="images/logout.png"/'+'></a>';
        }
      }
      this.loadRemote();
    },
    
    logout: function() {
      this.user = null;
      var signin = 'javascript:document.app.' + this.loginType + '()';
      var userName = document.getElementById('welcome');
      userName.innerHTML = 'Sign In: &nbsp;' + '<a href="'+signin+'"><img src="https://browserid.org/i/sign_in_blue.png"/'+'></a>' ;
      this.render();
    },
    
    // DISCOVERY
    getWebIDAuthURI: function() {
      // Try localStorage first
      if ( window.localStorage.webIDAuthURI ) return  window.localStorage.webIDAuthURI;
      
      // TODO: Search loacal path for user prefs

      // TODO: Discovery via HTTP user URI, Webfinger
      
      // TODO: Discover vid HTTP / DOAP

      // Fallback to default location
      return this.webIDAuthURI;
    },
    
    
    // FRIENDS
    // Loads friends, callback to displayFriends
    loadFBFriends: function() {
      this.status('Loading friends...', true);
      var accessToken = window.location.hash.substring(1);
      var path = "https://graph.facebook.com/me/friends?";
      var queryParams = [accessToken, 'callback=document.app.displayFriends'];
      var query = queryParams.join('&');
      var url = path + query;

      // use jsonp to call the graph
      var script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);        
    },    
    
    // Displays friends
    displayFriends: function(data) {
      this.status('Loading friends...', false);
      var str;
      for (i=0; i<data['data'].length; i++) {
        var uri  = 'https://graph.facebook.com/' + data['data'][i].id;
        var name = data['data'][i].name;
        this.addFriend( uri, name );
      }
      this.render();
    },


    // LOAD DATA
    loadRemote: function() {
    },
    
    
    // SAVE DATA
    saveRemote: function() {
    },
    

    // RENDER DATA
    render: function() {
      that = this;
      //$('#main').empty();
            
    },
    
    
    // HELPERS
    addFriend: function(uri, name) {
      for (i=0; i<this.friends.length; i++) {
        if ( uri == this.friends[i]['@id'] && name == this.friends[i]['http://xmlns.com/foaf/0.1/name'] ) return;
      }
      
      this.friends.push({ "@id" : uri, "http://xmlns.com/foaf/0.1/name" : name });
      window.localStorage.friends = JSON.stringify(this.friends);
    },
    
    deleteFile: function(file) {
      var body = '';
      xhr = new XMLHttpRequest();
      xhr.open('DELETE', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(body);      
    },
    
    putFile: function(file, data) {
      xhr = new XMLHttpRequest();
      xhr.open('PUT', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(data);   
    },
    
    postFile: function(file, data) {
      xhr = new XMLHttpRequest();
      xhr.open('POST', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(data);   
    },
    
    createDirectory: function(dir) {
      var xhr = new XMLHttpRequest();
      xhr.open('MKCOL', dir, false);
      xhr.send();
    },

    status: function(message, add) {
      if (add) {
        this.statuses.push(message);
      } else {
        for (i=0; i<this.statuses.length; i++) {
          if (message == this.statuses[i]) {
            this.statuses.splice(i, 1);
          }
        }
      }
      if (this.statuses.length) {
        $('#status').html(this.statuses[0]);
      } else {
        $('#status').html('');
      }
    },

    
    makeURI: function(id) {
      if ( id.substring(0,7) == 'mailto:' ) {
        return id;
      } else if ( id.indexOf(':') != -1 ) {
        return id;
      } else {
        return 'mailto:' + id;
      }
    }
    
  };
  
  // ONLOAD
  $(document).ready(function() {
    document.app = new app; 
  });
  
})(jQuery);



</script>

</body>
</html>
